<?phpob_start(); //$_SESSION['debug']=SQL;//unset($_SESSION);class Autenticacao{	private $_usuarioRef;	private $_expirado;	private $_autenticado;	private $_timestamp;	private $_ip;	private $_login;	private $_senha;	private $_redirect = "";	private $_tipoRedir;	var $_objRamal;	var $_ramalLogado;		function __construct(SisUsuario &$usuario = NULL, $login = NULL, $senha = NULL, $tipoRedir = PHP_REDIR,$ramal = NULL){		$this->_tipoRedir = $tipoRedir;		$this->_usuarioRef = $usuario;		$this->_timestamp = time();		$this->_ip = REMOTE_ADDR;		if(defined("AUTENTICACAO")){			if(AUTENTICACAO==0){				echo "Atencao: Aplicativo sem controle de acesso!";				return $this->redirect();			}		}		$this->_objSisPerfilPermissoes = new SisPerfilPermissoes();				$erro = $this->validaSessao();		if( $erro ){						if(!empty($login) && !empty($senha)){								$this->setLogin($login); 				$this->setSenha($senha);				$where_str = "nom_login = '".$this->_login."' and  nom_senha = md5('".$this->_senha."')";				$dadosUsuario = $this->_usuarioRef->listar("*",$where_str)->getDados();				$this->_autenticado = count($dadosUsuario) ? true : false;				if($this->_usuarioRef->isCancelado())					$this->redirect(ERRO_ACESSO_CANCELADO);					if($this->_autenticado) {										$this->setSessao( $dadosUsuario[0] );					$this->_usuarioRef->logon();				}elseif(!$this->_autenticado) {					 $this->redirect(ERRO_LOGIN);					 return;				}				elseif(!$this->_autenticado) {					 $this->redirect(ERRO_LOGADO);					 return;				}			} else{ 				$this->redirect(ERRO_VAZIO);							}		} else {			$this->_usuarioRef->populate($_SESSION['usr']);			$this->_autenticado = true;		}			return $this->redirect();	}	function setLogin($login) { $this->_login = $login; }	function setSenha($senha) { $this->_senha = $senha; }	function setTipoRedir($tipoRedir) { $this->_tipoRedir = $tipoRedir; }	function logoff() {  $this->_usuarioRef->logoff(); }	function isAutenticado(){		return $this->_autenticado;	}		function validaSessao(){				$autenticacao = @$_SESSION['autenticacao'];		$nome = $autenticacao['nom_usuario'];		$ip = $autenticacao['ip'];		$hora = $autenticacao['hora'];		$chave = $autenticacao['chave'];		if($chave != md5($nome . CHAVE_AUTENTICACAO . $ip . $hora)){			return ERRO_ACESSO_NEGADO;		}		if($hora + (60 * 60) < time())  {						 $this->redirect(ERRO_ACESSO_EXPIRADO);		}		$hora = time();		//recria a chave		$chave = md5($nome . CHAVE_AUTENTICACAO . $ip . $hora);		 $aut['nom_usuario'] = $nome;		 $aut['ip'] = $ip;		 $aut['hora'] = $hora;		 $aut['chave'] = $chave;		 $_SESSION['autenticacao'] = $aut;		return 0;	}	function redirect($opt = 0, $xajax = false){				    $redirect = false;				    $cod_equipe = isset($_SESSION['usr']['cod_equipe']) ? $_SESSION['usr']['cod_equipe'] : 0;	    if(isset($_SERVER['REQUEST_URI'])){		$next = $_SERVER['REQUEST_URI'];	    }        	    if(CONSTRUCAO) { 		    $this->_redirect = "appConstrucao.php";		    $redirect = $cod_equipe == 1 ? false : true;		    }elseif(MANUTENCAO) { 		    $this->_redirect = "appManutencao.php";		    $redirect = $this->_usuarioRef->cod_equipe == 1 ? false : true;	    }elseif( $opt ) {		    $this->_redirect = "appLogin.php?next={$next}";		    // versao antiga: $this->_redirect = "appAcesso.php?erro={$opt}&next={$next}";		    $redirect = true;	    }	    if($redirect){		switch($this->_tipoRedir){		    case AJAX_REDIR: 			    $script = "window.location = '".$this->_redirect.";";			    return $script;			    break;		    case JS_REDIR:				    $script = "<html><head><script language='Javascript'>window.location = '".$this->_redirect."';</script></head><body></body></html>";			    echo $script;			    exit(0);			    break;		    case PHP_REDIR: 			    header("Location: ".$this->_redirect);					    exit(0);			    break;		}	    }				}	function getRedirect(){		return $this->_redirect;	}	function setSessao($dadosUsuario){		$arr_usuario = array();		$nom_usuario = $this->_usuarioRef->getNomUsuario();		$cod_usuario = $this->_usuarioRef->setCodUsuario($dadosUsuario['cod_usuario']);		$arr_usuario = $dadosUsuario;		$arr_usuario['cod_permissao'] = $this->_usuarioRef->permissoes();		//$update = $this->_usuarioRef->atualizar(array('dat_ultimo_login'=>date("Y-m-d H:i:s")),"cod_usuario = ".$dadosUsuario['cod_usuario']);		//echo "aaaaaaaaaaaaa";die;		//$arr_usuario['bol_ambiente'] = $this->_usuarioRef->bol_ambiente;		//$arr_usuario['permissao_equipe'] = $this->_objSisPermissoesEquipe->getSisPermissoesEquipe("A.cod_equipe=".$arr_usuario['cod_equipe']);		$arr_usuario['permissao_perfil'] = $this->_objSisPerfilPermissoes->listar()->getDados();		$arr_usuario['rPorPagina'] = LINHASPORPAGINA;		$arr_usuario['IP'] = $this->_ip;		$ip = REMOTE_ADDR;		$hora = time();		$chave = md5($nom_usuario . CHAVE_AUTENTICACAO . $ip . $hora);		 	//	print_r($arr_usuario);	//	die();		//BUSCANDO AS CONFIGURAï¿½OES DA EQUIPE 		$autenticacao['nom_usuario'] = $nom_usuario;		$autenticacao['ip'] = $ip;		$autenticacao['hora'] = $hora;		$autenticacao['chave'] = $chave;		$autenticacao['app'] = APLICACAO;				$_SESSION['autenticacao'] = $autenticacao;		$_SESSION['usr'] = $arr_usuario; 	}}//ob_end_flush();?>